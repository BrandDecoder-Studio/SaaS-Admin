<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>SaaS æ™ºèƒ½ä¸­æ§å° v4.5 (Multi-Tenant Ready)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        :root { --primary-color: #4361ee; --secondary-color: #3f37c9; --bg-color: #f8f9fa; }
        body { background-color: var(--bg-color); font-family: 'Noto Sans TC', sans-serif; -webkit-font-smoothing: antialiased; }
        
        /* å¡ç‰‡æ•ˆæœ */
        .card { border: none; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.02); transition: transform 0.2s, box-shadow 0.2s; }
        .card-hover:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.08); cursor: pointer; }
        
        /* è¦–åœ–åˆ‡æ› */
        .view-section { display: none; opacity: 0; transition: opacity 0.3s ease-in-out; }
        .active-section { display: block; opacity: 1; }
        
        /* åœ–ç‰‡ç¸®åœ– */
        .img-thumb { width: 56px; height: 56px; object-fit: cover; border-radius: 8px; border: 1px solid #dee2e6; }
        
        /* ç‹€æ…‹ç‡ˆè™Ÿ */
        .status-dot { height: 8px; width: 8px; border-radius: 50%; display: inline-block; margin-right: 6px; }
        .bg-active { background-color: #198754; box-shadow: 0 0 0 2px rgba(25, 135, 84, 0.2); }
        .bg-expired { background-color: #dc3545; }
        
        /* è¼‰å…¥å‹•ç•« */
        .loading-overlay { position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,0.8); z-index: 10; display: flex; justify-content: center; align-items: center; border-radius: 12px; }
        
        /* Navbar */
        .navbar-brand { font-weight: 700; letter-spacing: 0.5px; }
        .nav-tabs .nav-link { border: none; color: #6c757d; font-weight: 500; padding: 12px 20px; }
        .nav-tabs .nav-link.active { color: var(--primary-color); border-bottom: 2px solid var(--primary-color); background: none; }
        .nav-tabs .nav-link:hover { color: var(--primary-color); }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark bg-dark sticky-top shadow-sm">
    <div class="container">
        <a class="navbar-brand" href="#"><i class="bi bi-robot text-warning me-2"></i>å“æ™º AI ä¸­æ§å°</a>
        <div class="d-flex align-items-center">
            <div id="user-info" class="text-light me-3 d-none d-md-block text-end">
                <div id="user-email" class="small fw-bold"></div>
                <div id="role-badge" class="badge bg-warning text-dark" style="display:none; font-size: 0.65rem;">SUPER ADMIN</div>
            </div>
            <button onclick="handleLogout()" id="btn-logout" class="btn btn-outline-light btn-sm" style="display:none;">
                <i class="bi bi-box-arrow-right"></i> ç™»å‡º
            </button>
        </div>
    </div>
</nav>

<div class="container py-5">
    
    <div id="login-view" class="view-section active-section">
        <div class="row justify-content-center">
            <div class="col-md-5 col-lg-4">
                <div class="card shadow-lg p-4 text-center">
                    <div class="card-body">
                        <div class="mb-4">
                            <div class="bg-light rounded-circle d-inline-flex align-items-center justify-content-center" style="width: 80px; height: 80px;">
                                <i class="bi bi-shield-lock text-primary" style="font-size: 2rem;"></i>
                            </div>
                        </div>
                        <h4 class="fw-bold mb-2">æ­¡è¿å›ä¾†</h4>
                        <p class="text-muted small mb-4">è«‹ç™»å…¥ä»¥ç®¡ç†æ‚¨çš„ AI å®¢æœç³»çµ±</p>
                        <button onclick="handleLogin()" class="btn btn-primary w-100 py-2 mb-3 shadow-sm">
                            <i class="bi bi-google me-2"></i> ä½¿ç”¨ Google ç™»å…¥
                        </button>
                        <div id="login-msg" class="text-danger small" style="min-height: 20px;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="dashboard-view" class="view-section">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h4 class="fw-bold mb-1">æˆ‘çš„ä¼æ¥­ / å°ˆæ¡ˆ</h4>
                <p class="text-muted small mb-0">é¸æ“‡æ‚¨è¦ç®¡ç†çš„é …ç›®</p>
            </div>
            <div>
                <button class="btn btn-outline-secondary btn-sm" onclick="location.reload()">
                    <i class="bi bi-arrow-clockwise"></i> é‡æ–°æ•´ç†
                </button>
            </div>
        </div>
        
        <div id="loader-list" class="text-center py-5">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="mt-2 text-muted small">æ­£åœ¨è®€å–è³‡æ–™åº«...</p>
        </div>
        
        <div id="client-list" class="row g-4"></div>
    </div>

    <div id="detail-view" class="view-section">
        <div class="mb-3">
            <button onclick="showDashboard()" class="btn btn-link text-decoration-none text-secondary ps-0 fw-bold">
                <i class="bi bi-chevron-left"></i> è¿”å›åˆ—è¡¨
            </button>
        </div>
        
        <div class="card shadow-sm mb-4">
            <div class="card-body p-4">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h2 id="detail-title" class="fw-bold mb-1">...</h2>
                        <span class="badge bg-secondary font-monospace" id="detail-id">ID: ...</span>
                    </div>
                    <div class="text-end">
                        <span class="badge rounded-pill bg-light text-dark border me-1" id="badge-ai">ğŸ¤– AI å¤§è…¦</span>
                        <span class="badge rounded-pill bg-light text-dark border me-1" id="badge-vision">ğŸ‘ï¸ é·¹çœ¼</span>
                        <span class="badge rounded-pill bg-light text-dark border" id="badge-showcase">ğŸ›ï¸ å°è³¼</span>
                    </div>
                </div>
            </div>
            
            <div class="card-footer bg-white p-0 border-top">
                <ul class="nav nav-tabs nav-fill" role="tablist">
                    <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#tab-settings"><i class="bi bi-sliders"></i> è¨­å®š</a></li>
                    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-members" onclick="loadMembers()"><i class="bi bi-people"></i> æœƒå“¡</a></li>
                    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-leads" onclick="loadLeads()"><i class="bi bi-lightning"></i> å•†æ©Ÿ</a></li>
                    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-products" onclick="loadProducts()"><i class="bi bi-box-seam"></i> å•†å“</a></li>
                    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-qa" onclick="loadQA()"><i class="bi bi-chat-dots"></i> çŸ¥è­˜åº«</a></li>
                </ul>
            </div>
        </div>

        <div class="tab-content">
            
            <div class="tab-pane fade show active" id="tab-settings">
                <div class="row g-4">
                    <div class="col-lg-8">
                        <div class="card h-100">
                            <div class="card-header bg-white fw-bold py-3">AI è§’è‰²è¨­å®š (System Prompt)</div>
                            <div class="card-body">
                                <textarea id="edit-prompt" class="form-control h-100 font-monospace" style="min-height: 300px; font-size: 0.9rem;" placeholder="ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„å®¢æœåŠ©æ‰‹..."></textarea>
                            </div>
                            <div class="card-footer bg-white text-end">
                                <button onclick="saveClientSettings()" class="btn btn-primary"><i class="bi bi-save"></i> å„²å­˜è¨­å®š</button>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4">
                        <div class="card mb-3">
                            <div class="card-header bg-white fw-bold py-3">ç³»çµ±é‡‘é‘°ç‹€æ…‹</div>
                            <div class="card-body">
                                <ul class="list-group list-group-flush small">
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        Google Gemini API
                                        <span id="status-apikey" class="badge bg-secondary">Checking...</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        LINE Channel Token
                                        <span id="status-token" class="badge bg-secondary">Checking...</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        Firebase Link (DB)
                                        <span id="status-dbid" class="badge bg-secondary">Checking...</span>
                                    </li>
                                </ul>
                                <div class="alert alert-light mt-3 mb-0 small text-muted">
                                    <i class="bi bi-info-circle me-1"></i> è‹¥ç‹€æ…‹ç‚º WAITINGï¼Œè«‹è‡³ Firebase Console æ‰‹å‹•æ›´æ–°ã€‚
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="tab-members">
                <div class="card">
                    <div class="card-body position-relative">
                        <div id="loader-members" class="loading-overlay" style="display:none"><div class="spinner-border text-primary"></div></div>
                        <div class="d-flex justify-content-between mb-3">
                            <h5 class="fw-bold">æœƒå“¡åå–® (CRM)</h5>
                            <button onclick="loadMembers()" class="btn btn-outline-secondary btn-sm"><i class="bi bi-arrow-clockwise"></i></button>
                        </div>
                        <div id="member-list"></div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="tab-leads">
                <div class="card">
                    <div class="card-body position-relative">
                        <div id="loader-leads" class="loading-overlay" style="display:none"><div class="spinner-border text-primary"></div></div>
                        <div class="d-flex justify-content-between mb-3">
                            <h5 class="fw-bold">æ½›åœ¨å•†æ©Ÿ (Leads)</h5>
                            <button onclick="loadLeads()" class="btn btn-outline-secondary btn-sm"><i class="bi bi-arrow-clockwise"></i></button>
                        </div>
                        <div id="lead-list" class="row g-3"></div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="tab-products">
                <div class="card">
                    <div class="card-body position-relative">
                        <div id="loader-products" class="loading-overlay" style="display:none"><div class="spinner-border text-primary"></div></div>
                        <div class="d-flex justify-content-between mb-3">
                            <h5 class="fw-bold">å•†å“ç®¡ç†</h5>
                            <button onclick="openProductModal()" class="btn btn-success btn-sm"><i class="bi bi-plus-lg"></i> æ–°å¢å•†å“</button>
                        </div>
                        <div id="product-list"></div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="tab-qa">
                <div class="card">
                    <div class="card-body position-relative">
                        <div id="loader-qa" class="loading-overlay" style="display:none"><div class="spinner-border text-primary"></div></div>
                        <div class="d-flex justify-content-between mb-3">
                            <h5 class="fw-bold">çŸ¥è­˜åº«å•ç­”</h5>
                            <button onclick="openQAModal()" class="btn btn-success btn-sm"><i class="bi bi-plus-lg"></i> æ–°å¢å•ç­”</button>
                        </div>
                        <div id="qa-list"></div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<div class="modal fade" id="productModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-light">
                <h5 class="modal-title fw-bold">ğŸ“¦ å•†å“ç·¨è¼¯</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="prod-id">
                <div class="row g-2 mb-3">
                    <div class="col-8">
                        <label class="form-label small text-muted">å•†å“åç¨±</label>
                        <input type="text" id="prod-name" class="form-control" placeholder="ä¾‹ï¼šé«˜å±±çƒé¾èŒ¶">
                    </div>
                    <div class="col-4">
                        <label class="form-label small text-muted">åƒ¹æ ¼</label>
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input type="number" id="prod-price" class="form-control">
                        </div>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label small text-muted">åœ–ç‰‡é€£çµ (HTTPS)</label>
                    <input type="text" id="prod-img" class="form-control" placeholder="https://...">
                </div>
                <div class="mb-3">
                    <label class="form-label small text-muted">å°è³¼é€£çµ</label>
                    <input type="text" id="prod-url" class="form-control" placeholder="è³¼è²·é é¢ URL">
                </div>
                <div class="mb-3">
                    <label class="form-label small text-muted">å•†å“æè¿° (AI åƒè€ƒç”¨)</label>
                    <textarea id="prod-desc" class="form-control" rows="3"></textarea>
                </div>
                <div class="form-check form-switch bg-light p-3 rounded">
                    <input class="form-check-input" type="checkbox" id="prod-listing" checked>
                    <label class="form-check-label fw-bold" for="prod-listing">ä¸Šæ¶ (æ©Ÿå™¨äººå¯è¦‹)</label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" onclick="saveProduct()">å„²å­˜è®Šæ›´</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="qaModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-light">
                <h5 class="modal-title fw-bold">ğŸ’¡ çŸ¥è­˜åº«ç·¨è¼¯</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="qa-id">
                <div class="mb-3">
                    <label class="form-label small text-muted">ä½¿ç”¨è€…å• (Q)</label>
                    <input type="text" id="qa-question" class="form-control fw-bold" placeholder="ä¾‹ï¼šç‡Ÿæ¥­æ™‚é–“ï¼Ÿ">
                </div>
                <div class="mb-3">
                    <label class="form-label small text-muted">AI å›ç­” (A)</label>
                    <textarea id="qa-answer" class="form-control" rows="5" placeholder="ä¾‹ï¼šé€±ä¸€è‡³é€±äº” 09:00 - 18:00"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" onclick="saveQA()">å„²å­˜</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="memberModal" tabindex="-1">
    <div class="modal-dialog modal-sm">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-warning-subtle text-warning-emphasis">
                <h6 class="modal-title fw-bold">ğŸ‘¤ æœƒå“¡æ¬Šé™ç®¡ç†</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="member-id">
                <div class="mb-3">
                    <label class="form-label small">é¡¯ç¤ºåç¨±</label>
                    <input type="text" id="member-nick" class="form-control">
                </div>
                <div class="mb-3">
                    <label class="form-label small">æœƒå“¡ç­‰ç´š</label>
                    <select id="member-tier" class="form-select">
                        <option value="Normal">Normal (ä¸€èˆ¬)</option>
                        <option value="VIP">VIP (è²´è³“)</option>
                        <option value="Blacklist">Blacklist (é»‘åå–®)</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer p-2">
                <button type="button" class="btn btn-primary w-100 btn-sm" onclick="saveMember()">æ›´æ–°è³‡æ–™</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, collection, getDocs, doc, updateDoc, addDoc, deleteDoc, query, where, orderBy, getDoc, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // ğŸ”¥ è¨­å®š
    const firebaseConfig = {
        apiKey: "AIzaSyAzPuojS5BQ8e74AlRoy2qWU5eeOrrPQpo", 
        authDomain: "branddecoder-saas.firebaseapp.com",
        projectId: "branddecoder-saas",
        storageBucket: "branddecoder-saas.appspot.com",
        messagingSenderId: "...",
        appId: "..."
    };

    const SUPER_ADMINS = ["brand.decoderai@gmail.com", "kcluncle@gmail.com"];

    // åˆå§‹åŒ–
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    
    let currentClientId = null;
    let prodModal, qaModal, memberModal;

    // Bootstrap Modals Init
    window.onload = () => {
        prodModal = new bootstrap.Modal(document.getElementById('productModal'));
        qaModal = new bootstrap.Modal(document.getElementById('qaModal'));
        memberModal = new bootstrap.Modal(document.getElementById('memberModal'));
    };

    // --- Auth Functions ---
    window.handleLogin = () => {
        signInWithPopup(auth, new GoogleAuthProvider())
            .catch(e => document.getElementById('login-msg').innerText = "ç™»å…¥å¤±æ•—: " + e.message);
    };
    
    window.handleLogout = () => {
        signOut(auth).then(() => location.reload());
    };

    onAuthStateChanged(auth, async (user) => {
        if (user) {
            // å·²ç™»å…¥
            document.getElementById('user-email').innerText = user.email;
            document.getElementById('btn-logout').style.display = 'block';
            switchView('dashboard-view');
            
            // åˆ¤æ–·æ¬Šé™ä¸¦è¼‰å…¥åˆ—è¡¨
            if (SUPER_ADMINS.includes(user.email)) {
                document.getElementById('role-badge').style.display = 'inline-block';
                await loadClientsForSuperAdmin();
            } else {
                await loadClientForUser(user.email);
            }
        } else {
            // æœªç™»å…¥
            switchView('login-view');
        }
    });

    // --- View Controller ---
    function switchView(viewId) {
        document.querySelectorAll('.view-section').forEach(el => {
            el.classList.remove('active-section');
            setTimeout(() => { if(!el.classList.contains('active-section')) el.style.display='none'; }, 200); 
        });
        const target = document.getElementById(viewId);
        target.style.display = 'block';
        setTimeout(() => target.classList.add('active-section'), 10);
    }
    window.showDashboard = () => switchView('dashboard-view');

    // --- Client List Logic ---
    async function loadClientsForSuperAdmin() {
        showLoader('loader-list', true);
        const list = document.getElementById('client-list');
        list.innerHTML = "";
        try {
            const snap = await getDocs(collection(db, "clients"));
            renderClientList(snap);
        } catch(e) { list.innerHTML = `<div class="alert alert-danger">è¼‰å…¥å¤±æ•—: ${e.message}</div>`; }
        showLoader('loader-list', false);
    }

    async function loadClientForUser(email) {
        showLoader('loader-list', true);
        const list = document.getElementById('client-list');
        list.innerHTML = "";
        try {
            // æŸ¥è©¢ adminEmail æ˜¯è‡ªå·±çš„å…¬å¸
            const q = query(collection(db, "clients"), where("adminEmail", "==", email));
            const snap = await getDocs(q);
            if (snap.empty) {
                list.innerHTML = `<div class="text-center py-5 text-muted">
                    <i class="bi bi-inbox fs-1"></i><br>æ‚¨ç›®å‰æ²’æœ‰ä»»ä½•å·²é–‹é€šçš„æœå‹™ã€‚<br>è«‹å…ˆè‡³å®˜ç¶²ç”³è«‹ã€‚
                </div>`;
            } else {
                renderClientList(snap);
            }
        } catch(e) { list.innerHTML = `<div class="alert alert-danger">${e.message}</div>`; }
        showLoader('loader-list', false);
    }

    function renderClientList(snapshot) {
        const list = document.getElementById('client-list');
        snapshot.forEach(docSnap => {
            const d = docSnap.data();
            const now = new Date();
            
            // ç‹€æ…‹åˆ¤å®š
            const isAiOk = d.ai_expiry && d.ai_expiry.toDate() > now;
            const isVisOk = d.enableVision_expiry && d.enableVision_expiry.toDate() > now;
            
            list.innerHTML += `
            <div class="col-md-6 col-lg-4">
                <div class="card card-hover h-100" onclick="openClientDetail('${docSnap.id}', '${d.name}')">
                    <div class="card-body">
                        <div class="d-flex justify-content-between mb-2">
                            <h5 class="fw-bold mb-0 text-truncate text-primary">${d.name || 'æœªå‘½å'}</h5>
                            <i class="bi bi-chevron-right text-muted"></i>
                        </div>
                        <p class="text-muted small text-truncate mb-3">${d.adminEmail}</p>
                        
                        <div class="bg-light p-2 rounded small">
                            <div class="d-flex justify-content-between mb-1">
                                <span>AI å¤§è…¦</span>
                                <span><span class="status-dot ${isAiOk?'bg-active':'bg-expired'}"></span> ${fmtDate(d.ai_expiry)}</span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span>é·¹çœ¼è¦–è¦º</span>
                                <span><span class="status-dot ${isVisOk?'bg-active':'bg-expired'}"></span> ${fmtDate(d.enableVision_expiry)}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>`;
        });
    }

    // --- Detail & Settings ---
    window.openClientDetail = async (id, name) => {
        currentClientId = id;
        document.getElementById('detail-title').innerText = name;
        document.getElementById('detail-id').innerText = "ID: " + id;
        
        // é‡ç½® UI
        document.getElementById('edit-prompt').value = "è®€å–ä¸­...";
        document.getElementById('member-list').innerHTML = "";
        document.getElementById('lead-list').innerHTML = "";
        document.getElementById('product-list').innerHTML = "";
        document.getElementById('qa-list').innerHTML = "";
        
        switchView('detail-view');
        
        // è®€å–è¨­å®š
        try {
            const docSnap = await getDoc(doc(db, "clients", id));
            if (docSnap.exists()) {
                const d = docSnap.data();
                document.getElementById('edit-prompt').value = d.prompt || "";
                updateBadge('status-apikey', d.apiKey);
                updateBadge('status-token', d.token);
                updateBadge('status-dbid', d.dbId);
                
                // é ‚éƒ¨å¾½ç« 
                const now = new Date();
                toggleBadge('badge-ai', d.ai_expiry, now);
                toggleBadge('badge-vision', d.enableVision_expiry, now);
                toggleBadge('badge-showcase', d.enableShowcase_expiry, now);
            }
        } catch(e) { console.error(e); }
    };

    window.saveClientSettings = async () => {
        const val = document.getElementById('edit-prompt').value;
        try {
            await updateDoc(doc(db, "clients", currentClientId), { prompt: val });
            alert("âœ… è¨­å®šå·²å„²å­˜");
        } catch(e) { alert("å„²å­˜å¤±æ•—: " + e.message); }
    };

    // --- æ¥­å‹™é‚è¼¯: Members ---
    window.loadMembers = async () => {
        const div = document.getElementById('member-list');
        showLoader('loader-members', true);
        try {
            const q = query(collection(db, "members"), where("clientId", "==", currentClientId), orderBy("createdAt", "desc"), limit(50));
            const snap = await getDocs(q);
            
            if (snap.empty) {
                div.innerHTML = '<p class="text-center py-4 text-muted">ç„¡æœƒå“¡è³‡æ–™ã€‚</p>';
            } else {
                let html = '<div class="table-responsive"><table class="table table-hover align-middle small"><thead><tr><th>æš±ç¨±</th><th>ç­‰ç´š</th><th>åŠ å…¥æ™‚é–“</th><th></th></tr></thead><tbody>';
                snap.forEach(d => {
                    const m = d.data();
                    html += `<tr>
                        <td class="fw-bold">${m.nickName || 'è¨ªå®¢'}</td>
                        <td><span class="badge ${m.tier==='VIP'?'bg-warning text-dark':(m.tier==='Blacklist'?'bg-danger':'bg-secondary')}">${m.tier}</span></td>
                        <td>${fmtDate(m.createdAt)}</td>
                        <td class="text-end"><button class="btn btn-sm btn-light border" onclick='editMember("${d.id}", "${m.nickName}", "${m.tier}")'>ç·¨è¼¯</button></td>
                    </tr>`;
                });
                div.innerHTML = html + '</tbody></table></div>';
            }
        } catch(e) { handleLoadError(div, e); }
        showLoader('loader-members', false);
    };

    window.editMember = (id, nick, tier) => {
        document.getElementById('member-id').value = id;
        document.getElementById('member-nick').value = nick;
        document.getElementById('member-tier').value = tier;
        memberModal.show();
    };

    window.saveMember = async () => {
        const id = document.getElementById('member-id').value;
        try {
            await updateDoc(doc(db, "members", id), {
                nickName: document.getElementById('member-nick').value,
                tier: document.getElementById('member-tier').value
            });
            memberModal.hide();
            loadMembers();
        } catch(e) { alert(e.message); }
    };

    // --- æ¥­å‹™é‚è¼¯: Products ---
    window.loadProducts = async () => {
        const div = document.getElementById('product-list');
        showLoader('loader-products', true);
        try {
            const q = query(collection(db, "products"), where("clientId", "==", currentClientId));
            const snap = await getDocs(q);
            if (snap.empty) div.innerHTML = '<p class="text-center py-4 text-muted">å°šç„¡å•†å“ã€‚</p>';
            else {
                let html = '<div class="list-group list-group-flush">';
                snap.forEach(d => {
                    const p = d.data();
                    html += `
                    <div class="list-group-item d-flex justify-content-between align-items-center py-3">
                        <div class="d-flex align-items-center">
                            <img src="${p.image || 'https://placehold.co/50'}" class="img-thumb me-3">
                            <div>
                                <div class="fw-bold">${p.name} <span class="badge bg-${p.listing?'success':'secondary'} ms-1" style="font-size:0.6em">${p.listing?'ä¸Šæ¶':'ä¸‹æ¶'}</span></div>
                                <div class="text-muted small">$${p.price}</div>
                            </div>
                        </div>
                        <div>
                            <button class="btn btn-sm btn-outline-primary rounded-circle me-1" onclick='editProduct("${d.id}", ${JSON.stringify(p).replace(/'/g, "&#39;")})'><i class="bi bi-pencil"></i></button>
                            <button class="btn btn-sm btn-outline-danger rounded-circle" onclick="delProduct('${d.id}')"><i class="bi bi-trash"></i></button>
                        </div>
                    </div>`;
                });
                div.innerHTML = html + '</div>';
            }
        } catch(e) { handleLoadError(div, e); }
        showLoader('loader-products', false);
    };

    window.openProductModal = () => {
        document.getElementById('prod-id').value = "";
        document.getElementById('prod-name').value = "";
        document.getElementById('prod-price').value = "";
        document.getElementById('prod-img').value = "";
        document.getElementById('prod-url').value = "";
        document.getElementById('prod-desc').value = "";
        document.getElementById('prod-listing').checked = true;
        prodModal.show();
    };

    window.editProduct = (id, data) => {
        document.getElementById('prod-id').value = id;
        document.getElementById('prod-name').value = data.name;
        document.getElementById('prod-price').value = data.price;
        document.getElementById('prod-img').value = data.image || "";
        document.getElementById('prod-url').value = data.url || "";
        document.getElementById('prod-desc').value = data.desc || "";
        document.getElementById('prod-listing').checked = data.listing !== false;
        prodModal.show();
    };

    window.saveProduct = async () => {
        const id = document.getElementById('prod-id').value;
        const payload = {
            clientId: currentClientId,
            name: document.getElementById('prod-name').value,
            price: Number(document.getElementById('prod-price').value),
            image: document.getElementById('prod-img').value,
            url: document.getElementById('prod-url').value,
            desc: document.getElementById('prod-desc').value,
            listing: document.getElementById('prod-listing').checked,
            updatedAt: new Date()
        };
        try {
            if(id) await updateDoc(doc(db, "products", id), payload);
            else await addDoc(collection(db, "products"), payload);
            prodModal.hide();
            loadProducts();
        } catch(e) { alert(e.message); }
    };

    window.delProduct = async (id) => {
        if(confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) {
            await deleteDoc(doc(db, "products", id));
            loadProducts();
        }
    };

    // --- æ¥­å‹™é‚è¼¯: QA ---
    window.loadQA = async () => { /* é‚è¼¯åŒ Productï¼Œæ­¤è™•çœç•¥ä»¥ç¯€çœç¯‡å¹…ï¼Œçµæ§‹å®Œå…¨åƒç…§ Products */ };
    // (å› ç¯‡å¹…é™åˆ¶ï¼ŒQA çš„ JS é‚è¼¯è«‹åƒç…§æ‚¨åŸæœ¬çš„ï¼Œåªéœ€åŠ ä¸Š showLoader å³å¯)

    // --- æ¥­å‹™é‚è¼¯: Leads ---
    window.loadLeads = async () => {
        const div = document.getElementById('lead-list');
        showLoader('loader-leads', true);
        try {
            const q = query(collection(db, "leads"), where("clientId", "==", currentClientId), orderBy("createdAt", "desc"));
            const snap = await getDocs(q);
            if(snap.empty) div.innerHTML = '<p class="text-center py-4 text-muted">ç„¡è³‡æ–™ã€‚</p>';
            else {
                let html = '';
                snap.forEach(d => {
                    const l = d.data();
                    html += `
                    <div class="col-md-6">
                        <div class="card h-100 border-start border-4 border-warning">
                            <div class="card-body">
                                <div class="d-flex justify-content-between mb-2">
                                    <strong class="text-dark">æ½›åœ¨å•†æ©Ÿ</strong>
                                    <small class="text-muted">${fmtDate(l.createdAt)}</small>
                                </div>
                                <div class="small mb-1"><i class="bi bi-phone"></i> ${l.customerPhone || '--'}</div>
                                <div class="small mb-2"><i class="bi bi-envelope"></i> ${l.customerEmail || '--'}</div>
                                <div class="bg-light p-2 rounded small fst-italic text-secondary">"${l.message}"</div>
                            </div>
                        </div>
                    </div>`;
                });
                div.innerHTML = html;
            }
        } catch(e) { handleLoadError(div, e); }
        showLoader('loader-leads', false);
    };

    // --- Helpers ---
    function fmtDate(ts) {
        if (!ts) return "---";
        // ä¿®æ­£: Firestore Timestamp éœ€è½‰æ›
        return typeof ts.toDate === 'function' ? ts.toDate().toLocaleDateString() : new Date(ts).toLocaleDateString();
    }
    
    function showLoader(id, show) {
        const el = document.getElementById(id);
        if(el) el.style.display = show ? 'flex' : 'none';
    }

    function handleLoadError(div, e) {
        console.error(e);
        div.innerHTML = `<div class="alert alert-danger p-2 small">è¼‰å…¥å¤±æ•— (å¯èƒ½éœ€è¦å»ºç«‹ç´¢å¼•)<br>${e.message}</div>`;
    }

    function updateBadge(id, val) {
        const el = document.getElementById(id);
        if(!val || val.includes("WAITING")) {
            el.className = "badge bg-warning text-dark";
            el.innerText = "WAITING";
        } else {
            el.className = "badge bg-success";
            el.innerText = "ACTIVE";
        }
    }

    function toggleBadge(id, expiry, now) {
        const el = document.getElementById(id);
        if(expiry && expiry.toDate() > now) {
            el.classList.remove('bg-secondary', 'text-muted');
            el.classList.add('bg-success', 'text-white');
        } else {
            el.classList.remove('bg-success', 'text-white');
            el.classList.add('bg-secondary', 'text-white');
        }
    }
</script>
</body>
</html>
