<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>SaaS æ™ºèƒ½ä¸­æ§å° v4.9 (Multi-Tenant)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        body { background-color: #f8f9fa; font-family: 'Segoe UI', sans-serif; }
        .view-section { display: none; }
        .active-section { display: block; animation: fadeIn 0.3s; }
        .card-hover:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); cursor: pointer; transition: all 0.2s; }
        .img-thumb { width: 48px; height: 48px; object-fit: cover; border-radius: 6px; border: 1px solid #dee2e6; }
        .status-dot { height: 10px; width: 10px; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .bg-active { background-color: #198754; box-shadow: 0 0 4px #198754; }
        .bg-expired { background-color: #dc3545; }
        .loading-overlay { display: none; text-align: center; padding: 20px; color: #6c757d; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4 shadow-sm">
    <div class="container">
        <a class="navbar-brand" href="#"><i class="bi bi-cpu text-warning me-2"></i>å“æ™º AI ä¸­æ§ (v4.9)</a>
        <div class="d-flex align-items-center">
            <span id="user-display" class="text-light me-3 small opacity-75"></span>
            <span id="role-badge" class="badge bg-warning text-dark me-3" style="display:none">SUPER ADMIN</span>
            <button onclick="handleLogout()" id="btn-logout" class="btn btn-outline-light btn-sm" style="display:none">ç™»å‡º</button>
        </div>
    </div>
</nav>

<div class="container pb-5">

    <div id="login-view" class="view-section active-section text-center mt-5">
        <div class="card mx-auto shadow border-0" style="max-width: 400px;">
            <div class="card-body p-5">
                <i class="bi bi-person-circle text-primary" style="font-size: 3rem;"></i>
                <h4 class="mt-3 mb-4">SaaS å¾Œå°ç™»å…¥</h4>
                <button onclick="handleLogin()" class="btn btn-primary w-100 rounded-pill"><i class="bi bi-google me-2"></i> Google ç™»å…¥</button>
                <div id="login-msg" class="text-danger mt-3 small"></div>
            </div>
        </div>
    </div>

    <div id="dashboard-view" class="view-section">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div><h4 class="fw-bold mb-0">å°ˆæ¡ˆç®¡ç†åˆ—è¡¨</h4><small class="text-muted" id="filter-hint">è®€å–ä¸­...</small></div>
            <button class="btn btn-sm btn-outline-secondary" onclick="location.reload()"><i class="bi bi-arrow-clockwise"></i> åˆ·æ–°</button>
        </div>
        <div id="loader-list" class="text-center py-5"><div class="spinner-border text-primary"></div></div>
        <div id="client-list" class="row g-4"></div>
    </div>

    <div id="detail-view" class="view-section">
        <div class="mb-3">
            <a href="javascript:void(0)" onclick="showDashboard()" id="btn-back-list" class="d-inline-flex align-items-center text-decoration-none text-secondary fw-bold fs-5">
                <i class="bi bi-arrow-left-circle-fill me-2 text-primary"></i> è¿”å›åˆ—è¡¨
            </a>
        </div>
        
        <div class="card shadow-sm border-0 mb-4">
            <div class="card-body p-4">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h2 id="detail-title" class="fw-bold mb-1">è¼‰å…¥ä¸­...</h2>
                        <div class="font-monospace text-muted small">DocID: <span id="detail-docid">...</span> <br><span class="text-primary fw-bold">DB Key: <span id="detail-dbid">...</span></span></div>
                    </div>
                    <div class="text-end">
                        <span class="badge bg-light text-dark border me-1" id="top-badge-ai">AI å¤§è…¦</span>
                        <span class="badge bg-light text-dark border me-1" id="top-badge-vision">é·¹çœ¼</span>
                        <span class="badge bg-light text-dark border" id="top-badge-showcase">å°è³¼</span>
                    </div>
                </div>
            </div>
            <div class="card-footer bg-white p-0">
                <ul class="nav nav-tabs nav-fill border-bottom-0">
                    <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#tab-settings">è¨­å®š</a></li>
                    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-members" onclick="loadMembers()">æœƒå“¡ CRM</a></li>
                    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-leads" onclick="loadLeads()">å•†æ©Ÿ Leads</a></li>
                    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-products" onclick="loadProducts()">å•†å“åº«</a></li>
                    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-qa" onclick="loadQA()">çŸ¥è­˜åº« QA</a></li>
                </ul>
            </div>
        </div>

        <div class="tab-content">
            <div class="tab-pane fade show active" id="tab-settings">
                <div class="row g-4">
                    <div class="col-md-8">
                        <div class="card h-100">
                            <div class="card-header bg-white fw-bold">AI äººè¨­</div>
                            <div class="card-body"><textarea id="edit-prompt" class="form-control h-100" style="min-height:300px"></textarea></div>
                            <div class="card-footer bg-white text-end"><button onclick="saveClientSettings()" class="btn btn-primary">å„²å­˜</button></div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card mb-3">
                            <div class="card-header bg-white fw-bold">ç³»çµ±ç‹€æ…‹</div>
                            <ul class="list-group list-group-flush small">
                                <li class="list-group-item d-flex justify-content-between">API Key <span id="status-apikey" class="badge">...</span></li>
                                <li class="list-group-item d-flex justify-content-between">Line Token <span id="status-token" class="badge">...</span></li>
                                <li class="list-group-item d-flex justify-content-between">DB Link <span id="status-dbid" class="badge">...</span></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <div class="tab-pane fade" id="tab-members">
                <div class="card">
                    <div class="card-header bg-white d-flex justify-content-between">
                        <h6 class="mb-0 fw-bold">æœƒå“¡åˆ—è¡¨</h6>
                        <div><button onclick="openMemberModal()" class="btn btn-success btn-sm me-1">æ–°å¢</button><button onclick="loadMembers()" class="btn btn-light btn-sm border">åˆ·æ–°</button></div>
                    </div>
                    <div class="card-body p-0">
                        <div id="loader-members" class="loading-overlay"><div class="spinner-border text-primary"></div></div>
                        <div id="member-list"></div>
                    </div>
                </div>
            </div>
            <div class="tab-pane fade" id="tab-leads">
                <div class="card">
                    <div class="card-header bg-white d-flex justify-content-between"><h6 class="mb-0 fw-bold">å•†æ©Ÿé›·é”</h6><button onclick="loadLeads()" class="btn btn-light btn-sm border">åˆ·æ–°</button></div>
                    <div class="card-body"><div id="loader-leads" class="loading-overlay"><div class="spinner-border text-primary"></div></div><div id="lead-list" class="row g-3"></div></div>
                </div>
            </div>
            <div class="tab-pane fade" id="tab-products">
                <div class="card">
                    <div class="card-header bg-white d-flex justify-content-between"><h6 class="mb-0 fw-bold">å•†å“ç®¡ç†</h6><div><button onclick="openProductModal()" class="btn btn-success btn-sm me-1">æ–°å¢</button><button onclick="loadProducts()" class="btn btn-light btn-sm border">åˆ·æ–°</button></div></div>
                    <div class="card-body p-0"><div id="loader-products" class="loading-overlay"><div class="spinner-border text-primary"></div></div><div id="product-list"></div></div>
                </div>
            </div>
            <div class="tab-pane fade" id="tab-qa">
                <div class="card">
                    <div class="card-header bg-white d-flex justify-content-between"><h6 class="mb-0 fw-bold">çŸ¥è­˜åº« QA</h6><div><button onclick="openQAModal()" class="btn btn-success btn-sm me-1">æ–°å¢</button><button onclick="loadQA()" class="btn btn-light btn-sm border">åˆ·æ–°</button></div></div>
                    <div class="card-body p-0"><div id="loader-qa" class="loading-overlay"><div class="spinner-border text-primary"></div></div><div id="qa-list"></div></div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="productModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header bg-light"><h5 class="modal-title">å•†å“ç·¨è¼¯</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><input type="hidden" id="prod-id"><div class="mb-2"><label>åç¨±</label><input type="text" id="prod-name" class="form-control"></div><div class="mb-2"><label>åƒ¹æ ¼</label><input type="number" id="prod-price" class="form-control"></div><div class="mb-2"><label>åœ–ç‰‡ URL</label><input type="text" id="prod-img" class="form-control"></div><div class="mb-2"><label>å°è³¼ URL</label><input type="text" id="prod-url" class="form-control"></div><div class="mb-2"><label>æè¿°</label><textarea id="prod-desc" class="form-control" rows="2"></textarea></div><div class="form-check form-switch mt-3"><input class="form-check-input" type="checkbox" id="prod-listing" checked><label>ä¸Šæ¶</label></div></div><div class="modal-footer"><button type="button" class="btn btn-primary" onclick="saveProduct()">å„²å­˜</button></div></div></div></div>
<div class="modal fade" id="qaModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header bg-light"><h5 class="modal-title">QA ç·¨è¼¯</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><input type="hidden" id="qa-id"><div class="mb-3"><label>å•é¡Œ (Q)</label><input type="text" id="qa-question" class="form-control"></div><div class="mb-2"><label>å›ç­” (A)</label><textarea id="qa-answer" class="form-control" rows="4"></textarea></div></div><div class="modal-footer"><button type="button" class="btn btn-primary" onclick="saveQA()">å„²å­˜</button></div></div></div></div>
<div class="modal fade" id="memberModal" tabindex="-1"><div class="modal-dialog modal-sm"><div class="modal-content"><div class="modal-header bg-light"><h5 class="modal-title">æœƒå“¡ç·¨è¼¯</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><input type="hidden" id="member-id"><div class="mb-2"><label>æš±ç¨±</label><input type="text" id="member-nick" class="form-control"></div><div class="mb-2"><label>ç­‰ç´š</label><select id="member-tier" class="form-select"><option value="Normal">Normal</option><option value="VIP">VIP</option><option value="Blacklist">Blacklist</option></select></div></div><div class="modal-footer"><button type="button" class="btn btn-primary w-100" onclick="saveMember()">æ›´æ–°</button></div></div></div></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, collection, getDocs, doc, updateDoc, addDoc, deleteDoc, query, where, orderBy, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // Config
    const firebaseConfig = {
        apiKey: "AIzaSyAzPuojS5BQ8e74AlRoy2qWU5eeOrrPQpo", 
        authDomain: "branddecoder-saas.firebaseapp.com",
        projectId: "branddecoder-saas",
        storageBucket: "branddecoder-saas.appspot.com",
        messagingSenderId: "...",
        appId: "..."
    };

    const SUPER_ADMINS = ["brand.decoderai@gmail.com", "kcluncle@gmail.com"];

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    
    let currentDocId = null;
    let currentDbId = null; 
    let prodModal, qaModal, memberModal;

    window.onload = () => {
        prodModal = new bootstrap.Modal(document.getElementById('productModal'));
        qaModal = new bootstrap.Modal(document.getElementById('qaModal'));
        memberModal = new bootstrap.Modal(document.getElementById('memberModal'));
    };

    window.handleLogin = () => signInWithPopup(auth, new GoogleAuthProvider()).catch(e => document.getElementById('login-msg').innerText = e.message);
    window.handleLogout = () => signOut(auth).then(() => location.reload());

    // ğŸ”¥ æ ¸å¿ƒé‚è¼¯ä¿®æ”¹ï¼šè‡ªå‹•è½‰å€åˆ¤æ–·
    onAuthStateChanged(auth, async user => {
        if (user) {
            document.getElementById('user-display').innerText = user.email;
            document.getElementById('btn-logout').style.display = 'block';
            
            // åˆ¤æ–·æ˜¯å¦ç‚ºè¶…ç´šç®¡ç†å“¡
            const isSuper = SUPER_ADMINS.includes(user.email);
            
            if (isSuper) {
                // è¶…ç´šç®¡ç†å“¡ -> é¡¯ç¤ºåˆ—è¡¨ã€é¡¯ç¤ºè¿”å›æŒ‰éˆ•
                document.getElementById('role-badge').style.display = "inline-block";
                document.getElementById('filter-hint').innerText = "è¶…ç´šç®¡ç†å“¡æ¨¡å¼";
                document.getElementById('btn-back-list').style.display = 'inline-flex'; // é¡¯ç¤ºè¿”å›
                switchView('dashboard-view');
                await loadClientsForSuperAdmin();
            } else {
                // ä¸€èˆ¬åº—å®¶ -> éš±è—è¿”å›æŒ‰éˆ•ï¼Œä¸¦è§¸ç™¼è‡ªå‹•è¼‰å…¥
                document.getElementById('role-badge').style.display = "none";
                document.getElementById('filter-hint').innerText = `Owner: ${user.email}`;
                document.getElementById('btn-back-list').style.display = 'none'; // éš±è—è¿”å›ï¼Œé˜²æ­¢ä»–è·³å‡ºå»
                
                // æš«æ™‚é¡¯ç¤º dashboard (è¼‰å…¥ç•«é¢)ï¼Œç„¶å¾Œè‡ªå‹•è·³è½‰
                switchView('dashboard-view');
                await loadClientForUser(user.email);
            }
        } else {
            switchView('login-view');
        }
    });

    function switchView(viewId) {
        ['login-view', 'dashboard-view', 'detail-view'].forEach(id => {
            const el = document.getElementById(id);
            if(el) { el.style.display = 'none'; el.classList.remove('active-section'); }
        });
        const target = document.getElementById(viewId);
        if(target) { target.style.display = 'block'; setTimeout(() => target.classList.add('active-section'), 10); }
    }
    window.showDashboard = () => switchView('dashboard-view');

    async function loadClientsForSuperAdmin() { renderList(await getDocs(collection(db, "clients"))); }
    
    // ğŸ”¥ æ ¸å¿ƒé‚è¼¯ä¿®æ”¹ï¼šåº—å®¶ç™»å…¥å¾Œè‡ªå‹•è·³è½‰
    async function loadClientForUser(email) {
        document.getElementById('loader-list').style.display = 'block';
        const q = query(collection(db, "clients"), where("adminEmail", "==", email));
        const snap = await getDocs(q);
        document.getElementById('loader-list').style.display = 'none';
        
        if (snap.empty) {
            document.getElementById('client-list').innerHTML = `<div class="text-center py-5 text-muted"><h5>ç„¡æˆæ¬Šè³‡æ–™</h5><p>å¸³è™Ÿ <b>${email}</b> å°šæœªé–‹é€šä»»ä½• SaaS æœå‹™ã€‚</p></div>`;
        } else {
            // è‡ªå‹•é€²å…¥ç¬¬ä¸€ç­†è³‡æ–™
            const docSnap = snap.docs[0];
            const data = docSnap.data();
            console.log("åº—å®¶ç™»å…¥ï¼Œè‡ªå‹•è·³è½‰è‡³:", data.name);
            openClientDetail(docSnap.id, data.name, data.dbId);
        }
    }

    function renderList(snap) {
        const list = document.getElementById('client-list');
        list.innerHTML = "";
        document.getElementById('loader-list').style.display = 'none';
        snap.forEach(d => {
            const data = d.data();
            const aiOk = !isExp(data.ai_expiry);
            const visOk = !isExp(data.enableVision_expiry);
            const showOk = !isExp(data.enableShowcase_expiry); 
            list.innerHTML += `
            <div class="col-md-4">
                <div class="card card-hover h-100 p-3" onclick="openClientDetail('${d.id}', '${data.name}', '${data.dbId}')">
                    <div class="d-flex justify-content-between mb-2"><h5 class="fw-bold mb-0">${data.name||'æœªå‘½å'}</h5></div>
                    <p class="text-muted small mb-3">${data.adminEmail||'No Email'}</p>
                    <div class="bg-light p-2 rounded small">
                        <div class="d-flex justify-content-between mb-1"><span>AI å¤§è…¦</span><span><span class="status-dot ${aiOk?'bg-active':'bg-expired'}"></span>${fmtDate(data.ai_expiry)}</span></div>
                        <div class="d-flex justify-content-between mb-1"><span>é·¹çœ¼è¦–è¦º</span><span><span class="status-dot ${visOk?'bg-active':'bg-expired'}"></span>${fmtDate(data.enableVision_expiry)}</span></div>
                        <div class="d-flex justify-content-between"><span>å°è³¼å¡ç‰‡</span><span><span class="status-dot ${showOk?'bg-active':'bg-expired'}"></span>${fmtDate(data.enableShowcase_expiry)}</span></div>
                    </div>
                </div>
            </div>`;
        });
    }

    window.openClientDetail = async (id, name, dbIdFromList) => {
        currentDocId = id;
        currentDbId = dbIdFromList || id; 
        document.getElementById('detail-title').innerText = name;
        document.getElementById('detail-docid').innerText = id;
        document.getElementById('detail-dbid').innerText = currentDbId;
        ['member-list','lead-list','product-list','qa-list'].forEach(id => document.getElementById(id).innerHTML = '');
        switchView('detail-view');
        try {
            const docSnap = await getDoc(doc(db, "clients", id));
            if (docSnap.exists()) {
                const d = docSnap.data();
                if (d.dbId) { currentDbId = d.dbId; document.getElementById('detail-dbid').innerText = currentDbId; }
                document.getElementById('edit-prompt').value = d.prompt || "";
                const now = new Date();
                toggleTopBadge('top-badge-ai', d.ai_expiry, now);
                toggleTopBadge('top-badge-vision', d.enableVision_expiry, now);
                toggleTopBadge('top-badge-showcase', d.enableShowcase_expiry, now);
                updateStatus('status-apikey', d.apiKey);
                updateStatus('status-token', d.token);
                updateStatus('status-dbid', d.dbId);
            }
        } catch(e) { console.error(e); }
    };

    window.saveClientSettings = async () => {
        await updateDoc(doc(db, "clients", currentDocId), { prompt: document.getElementById('edit-prompt').value });
        alert("âœ… è¨­å®šå·²å„²å­˜");
    }

    // CRUD (ä¿æŒä¸è®Š)
    window.loadMembers = async () => loadCollection("members", "member-list", renderMemberTable);
    window.loadLeads = async () => loadCollection("leads", "lead-list", renderLeadCards);
    window.loadProducts = async () => loadCollection("products", "product-list", renderProductList);
    window.loadQA = async () => loadCollection("knowledge_base", "qa-list", renderQAList);

    async function loadCollection(colName, divId, renderFn) {
        const div = document.getElementById(divId);
        showLoader('loader-'+colName.split('_')[0], true);
        div.innerHTML = "";
        try {
            console.log("Loading " + colName + " for " + currentDbId);
            const q = query(collection(db, colName), where("clientId", "==", currentDbId));
            const snap = await getDocs(q);
            if (snap.empty) {
                div.innerHTML = '<p class="text-center text-muted py-3">å°šç„¡è³‡æ–™ã€‚</p>';
            } else {
                div.innerHTML = renderFn(snap);
            }
        } catch(e) {
            console.error(e);
            alert("è®€å–å¤±æ•—ï¼è«‹çœ‹ F12 Console: " + e.message);
            div.innerHTML = `<div class="alert alert-danger">Error: ${e.message}</div>`;
        }
        showLoader('loader-'+colName.split('_')[0], false);
    }

    function renderMemberTable(snap) {
        let h = '<div class="table-responsive"><table class="table table-hover align-middle"><thead><tr><th>æš±ç¨±</th><th>ç­‰ç´š</th><th>åŠ å…¥æ™‚é–“</th><th></th></tr></thead><tbody>';
        snap.forEach(d => { const m = d.data(); h += `<tr><td>${m.nickName||'è¨ªå®¢'}</td><td>${m.tier}</td><td>${fmtDate(m.createdAt)}</td><td class="text-end"><button class="btn btn-sm btn-light border" onclick='editMember("${d.id}", "${m.nickName}", "${m.tier}")'>ç·¨è¼¯</button></td></tr>`; });
        return h + '</tbody></table></div>';
    }
    function renderLeadCards(snap) {
        let h = '';
        snap.forEach(d => { const l = d.data(); h += `<div class="col-md-6"><div class="card h-100 border-start border-4 border-warning"><div class="card-body"><div class="d-flex justify-content-between mb-2"><strong>å•†æ©Ÿ</strong><small class="text-muted">${fmtDate(l.createdAt)}</small></div><div class="small">${l.customerPhone||'-'} / ${l.customerEmail||'-'}</div><div class="bg-light p-2 mt-2 rounded small text-muted">"${l.message}"</div></div></div></div>`; });
        return h;
    }
    function renderProductList(snap) {
        let h = '<div class="list-group list-group-flush">';
        snap.forEach(d => { const p = d.data(); h += `<div class="list-group-item d-flex justify-content-between align-items-center py-3"><div class="d-flex align-items-center"><img src="${p.image||'https://placehold.co/50'}" class="img-thumb me-3"><div><div class="fw-bold">${p.name}</div><div class="text-muted small">$${p.price}</div></div></div><div><button class="btn btn-sm btn-outline-primary rounded-circle me-1" onclick='editProduct("${d.id}", ${JSON.stringify(p).replace(/'/g, "&#39;")})'><i class="bi bi-pencil"></i></button><button class="btn btn-sm btn-outline-danger rounded-circle" onclick="delDoc('products','${d.id}')"><i class="bi bi-trash"></i></button></div></div>`; });
        return h + '</div>';
    }
    function renderQAList(snap) {
        let h = '<div class="accordion" id="qaAcc">';
        let i = 0;
        snap.forEach(d => { const qa = d.data(); i++; h += `<div class="accordion-item"><h2 class="accordion-header"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#c${i}"><span class="fw-bold me-2 text-primary">Q:</span>${qa.question}</button></h2><div id="c${i}" class="accordion-collapse collapse" data-bs-parent="#qaAcc"><div class="accordion-body bg-light"><div class="mb-2"><strong>A:</strong> ${qa.answer}</div><div class="text-end"><button class="btn btn-sm btn-primary me-2" onclick='editQA("${d.id}", ${JSON.stringify(qa).replace(/'/g, "&#39;")})'>ç·¨è¼¯</button><button class="btn btn-sm btn-danger" onclick="delDoc('knowledge_base','${d.id}')">åˆªé™¤</button></div></div></div></div>`; });
        return h + '</div>';
    }

    // Modals Helpers (ä¿æŒä¸è®Š)
    window.openMemberModal = () => { document.getElementById('member-id').value=""; document.getElementById('member-nick').value=""; document.getElementById('member-tier').value="Normal"; memberModal.show(); };
    window.editMember = (id, n, t) => { document.getElementById('member-id').value=id; document.getElementById('member-nick').value=n; document.getElementById('member-tier').value=t; memberModal.show(); };
    window.saveMember = async () => { 
        const id = document.getElementById('member-id').value;
        const payload = { nickName: document.getElementById('member-nick').value, tier: document.getElementById('member-tier').value };
        if(id) await updateDoc(doc(db, "members", id), payload); else { payload.clientId = currentDbId; payload.createdAt = new Date(); payload.userId = "MANUAL_"+Date.now(); await addDoc(collection(db, "members"), payload); }
        memberModal.hide(); loadMembers(); 
    };
    
    window.editProduct = (id, data) => { document.getElementById('prod-id').value=id; document.getElementById('prod-name').value=data.name; document.getElementById('prod-price').value=data.price; document.getElementById('prod-img').value=data.image; document.getElementById('prod-url').value=data.url; document.getElementById('prod-desc').value=data.desc; document.getElementById('prod-listing').checked=data.listing!==false; prodModal.show(); };
    window.openProductModal = () => { document.getElementById('prod-id').value=""; document.getElementById('prod-name').value=""; document.getElementById('prod-price').value=""; prodModal.show(); };
    window.saveProduct = async () => {
        const id = document.getElementById('prod-id').value;
        const d = { clientId: currentDbId, name: document.getElementById('prod-name').value, price: Number(document.getElementById('prod-price').value), image: document.getElementById('prod-img').value, url: document.getElementById('prod-url').value, desc: document.getElementById('prod-desc').value, listing: document.getElementById('prod-listing').checked, updatedAt: new Date() };
        if(id) await updateDoc(doc(db, "products", id), d); else await addDoc(collection(db, "products"), d);
        prodModal.hide(); loadProducts();
    };

    window.editQA = (id, data) => { document.getElementById('qa-id').value=id; document.getElementById('qa-question').value=data.question; document.getElementById('qa-answer').value=data.answer; qaModal.show(); };
    window.openQAModal = () => { document.getElementById('qa-id').value=""; document.getElementById('qa-question').value=""; document.getElementById('qa-answer').value=""; qaModal.show(); };
    window.saveQA = async () => {
        const id = document.getElementById('qa-id').value;
        const d = { clientId: currentDbId, question: document.getElementById('qa-question').value, answer: document.getElementById('qa-answer').value, updatedAt: new Date() };
        if(id) await updateDoc(doc(db, "knowledge_base", id), d); else await addDoc(collection(db, "knowledge_base"), d);
        qaModal.hide(); loadQA();
    };

    window.delDoc = async (col, id) => { if(confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) { await deleteDoc(doc(db, col, id)); if(col=='products') loadProducts(); else loadQA(); } };

    function fmtDate(ts) { if(!ts) return "---"; return new Date(ts.seconds*1000).toLocaleDateString(); }
    function isExp(ts) { if(!ts) return true; return new Date(ts.seconds*1000) < new Date(); }
    function toggleTopBadge(id, ts, now) { const el=document.getElementById(id); if(ts && new Date(ts.seconds*1000) > now) { el.className="badge bg-success me-1"; } else { el.className="badge bg-secondary me-1"; } }
    function updateStatus(id, val) { const el=document.getElementById(id); if(!val || val.includes("WAITING")) { el.className="badge bg-warning text-dark"; el.innerText="WAITING"; } else { el.className="badge bg-success"; el.innerText="ACTIVE"; } }
    function showLoader(id, show) { const el = document.getElementById(id); if(el) el.style.display = show ? 'flex' : 'none'; }
</script>
</body>
</html>
