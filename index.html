<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>SaaS ç³»çµ±ä¸­æ§å°</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f0f2f5; font-family: 'Segoe UI', sans-serif; }
        .login-wrapper { height: 100vh; display: flex; align-items: center; justify-content: center; }
        .login-card { width: 100%; max-width: 400px; padding: 40px; background: white; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); text-align: center; }
        .main-container { display: none; max-width: 1200px; margin: 40px auto; padding: 0 20px; }
        .card-custom { border: none; border-radius: 12px; background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.03); transition: all 0.2s; height: 100%; }
        .card-custom:hover { transform: translateY(-5px); box-shadow: 0 8px 20px rgba(0,0,0,0.06); }
        .status-dot { height: 10px; width: 10px; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .bot-id { font-family: monospace; color: #6c757d; font-size: 0.85em; background: #f8f9fa; padding: 2px 6px; border-radius: 4px; }
    </style>
</head>
<body>

<div id="login-view" class="login-wrapper">
    <div class="login-card">
        <h2 class="mb-4 fw-bold text-primary">ğŸ” SaaS ä¸­æ§å°</h2>
        <p class="text-muted mb-4">è«‹ä½¿ç”¨æˆæ¬Šçš„ç®¡ç†å“¡å¸³è™Ÿç™»å…¥</p>
        <button onclick="handleLogin()" class="btn btn-dark w-100 py-3 fw-bold">
            <svg class="me-2" width="20" height="20" viewBox="0 0 24 24"><path fill="currentColor" d="M21.35 11.1h-9.17v2.73h6.51c-.33 3.81-3.5 5.44-6.5 5.44C8.36 19.27 5 16.25 5 12c0-4.1 3.2-7.27 7.2-7.27c3.09 0 4.9 1.97 4.9 1.97L19 4.72S16.56 2 12.1 2C6.42 2 2.03 6.8 2.03 12.5S6.42 23 12.1 23c5.83 0 8.84-4.15 8.84-11.9z"/></svg>
            Google å¸³è™Ÿç™»å…¥
        </button>
    </div>
</div>

<div id="app-view" class="main-container">
    <div class="d-flex justify-content-between align-items-center mb-5">
        <div>
            <h3 class="fw-bold mb-1">å®¢æˆ¶ç®¡ç†å„€è¡¨æ¿</h3>
            <small class="text-muted" id="user-display">æœªç™»å…¥</small>
        </div>
        <button onclick="handleLogout()" class="btn btn-outline-danger btn-sm px-3">ç™»å‡ºç³»çµ±</button>
    </div>

    <div id="loader" class="text-center py-5">
        <div class="spinner-border text-primary" role="status"></div>
        <p class="mt-2 text-muted">æ­£åœ¨é€£ç·šè‡³ Firestore...</p>
    </div>

    <div id="client-list" class="row g-4"></div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, collection, getDocs, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // ğŸ”¥ã€è«‹è²¼ä¸Šæ‚¨çš„ Configã€‘
    const firebaseConfig = {
        apiKey: "AIzaSyAzPuojS5BQ8e74AlRoy2qWU5eeOrrPQpo", 
        authDomain: "branddecoder-saas.firebaseapp.com",
        projectId: "branddecoder-saas",
        storageBucket: "branddecoder-saas.appspot.com",
        messagingSenderId: "...",
        appId: "..."
    };

    // ğŸ”¥ã€æ¬Šé™ç™½åå–®ã€‘è«‹å¡«å…¥å…è¨±ç™»å…¥çš„ Email
    const ALLOWED_ADMINS = [
        "brand.decoderai@gmail.com", 
        "æ‚¨çš„å€‹äººGMAIL@gmail.com" 
    ];

    // åˆå§‹åŒ–
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ç™»å…¥é‚è¼¯
    window.handleLogin = () => {
        const provider = new GoogleAuthProvider();
        signInWithPopup(auth, provider).catch(err => alert("ç™»å…¥éŒ¯èª¤: " + err.message));
    };

    // ç™»å‡ºé‚è¼¯
    window.handleLogout = () => signOut(auth);

    // å„²å­˜é‚è¼¯ (æ›´æ–° Prompt)
    window.saveSettings = async (id) => {
        const btn = document.getElementById(`btn-${id}`);
        const promptVal = document.getElementById(`prompt-${id}`).value;
        const originalText = btn.innerHTML;
        
        btn.disabled = true;
        btn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> å„²å­˜ä¸­...`;
        
        try {
            await updateDoc(doc(db, "clients", id), { prompt: promptVal });
            btn.className = "btn btn-success btn-sm w-100";
            btn.innerHTML = "âœ… å·²æ›´æ–°è‡³é›²ç«¯";
            
            // 2ç§’å¾Œæ¢å¾©æŒ‰éˆ•
            setTimeout(() => { 
                btn.className = "btn btn-primary btn-sm w-100"; 
                btn.innerHTML = originalText; 
                btn.disabled = false; 
            }, 2000);
        } catch (e) {
            alert("å„²å­˜å¤±æ•—: " + e.message);
            btn.innerHTML = "âŒ å¤±æ•—";
            btn.className = "btn btn-danger btn-sm w-100";
            btn.disabled = false;
        }
    };

    // ç›£è½ç™»å…¥ç‹€æ…‹
    onAuthStateChanged(auth, user => {
        const loginView = document.getElementById('login-view');
        const appView = document.getElementById('app-view');
        
        if (user) {
            // æª¢æŸ¥æ˜¯å¦åœ¨ç™½åå–®å…§
            if (ALLOWED_ADMINS.includes(user.email)) {
                loginView.style.display = 'none';
                appView.style.display = 'block';
                document.getElementById('user-display').innerText = `ç®¡ç†å“¡: ${user.email}`;
                loadClients();
            } else {
                alert(`â›” æ¬Šé™ä¸è¶³ï¼š\næ‚¨çš„å¸³è™Ÿ (${user.email}) æœªæˆæ¬Šã€‚`);
                signOut(auth);
            }
        } else {
            loginView.style.display = 'flex';
            appView.style.display = 'none';
        }
    });

    // è®€å–å®¢æˆ¶è³‡æ–™
    async function loadClients() {
        const list = document.getElementById('client-list');
        const loader = document.getElementById('loader');
        list.innerHTML = "";
        
        try {
            const querySnapshot = await getDocs(collection(db, "clients"));
            loader.style.display = 'none';
            
            if (querySnapshot.empty) {
                list.innerHTML = `<div class="col-12 text-center text-muted">ç›®å‰æ²’æœ‰å®¢æˆ¶è³‡æ–™</div>`;
                return;
            }

            querySnapshot.forEach((docSnap) => {
                const data = docSnap.data();
                const id = docSnap.id;
                // æª¢æŸ¥æ˜¯å¦éæœŸ
                const expiryDate = data.expiry ? new Date(data.expiry.toDate()) : null;
                const isExpired = expiryDate && expiryDate < new Date();
                
                const html = `
                <div class="col-md-6 col-lg-4">
                    <div class="card p-4 card-custom">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="fw-bold m-0 text-dark">${data.name || "æœªå‘½åå®¢æˆ¶"}</h5>
                            <span class="badge ${isExpired ? 'bg-danger-subtle text-danger' : 'bg-success-subtle text-success'} rounded-pill">
                                ${isExpired ? 'å·²éæœŸ' : 'ç‡Ÿé‹ä¸­'}
                            </span>
                        </div>
                        
                        <div class="mb-3">
                            <span class="bot-id">ID: ${id.substring(0, 10)}...</span>
                        </div>

                        <div class="mb-4">
                            <label class="form-label text-muted small fw-bold">System Prompt (AIè¨­å®š)</label>
                            <textarea id="prompt-${id}" class="form-control form-control-sm bg-light" rows="6" style="font-size: 0.9em; border-color: #eee;">${data.prompt || ""}</textarea>
                        </div>
                        
                        <div class="mt-auto">
                            <button id="btn-${id}" onclick="saveSettings('${id}')" class="btn btn-primary btn-sm w-100 py-2 fw-bold">å„²å­˜è¨­å®š</button>
                        </div>
                    </div>
                </div>`;
                list.innerHTML += html;
            });
        } catch (e) {
            loader.innerHTML = `<p class="text-danger">è®€å–è³‡æ–™å¤±æ•—: ${e.message}</p>`;
        }
    }
</script>
</body>
</html>